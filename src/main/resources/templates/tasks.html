<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>All Tasks</title>
    <link rel="stylesheet" th:href="@{/css/headerstyle.css}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/footerstyle.css}">

    <script src="/js/clock.js" defer></script>

</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="page-wrapper">
    <div class="card">

        <div class="card-title-row">
            <h2>All Tasks</h2>

            <div class="card-actions">
                <button id="toggleViewBtn"
                        class="btn-add-task secondary"
                        type="button">
                    Card View
                </button>


                <div class="export-dropdown">
                    <button class="btn-export"
                            th:disabled="${taskCount == 0}">
                        Export ‚ñæ
                    </button>


                    <div class="export-menu">
                        <a href="/api/tasks/export/download">üì• Download CSV</a>
                        <a href="/api/tasks/export/email">üìß Send to Email</a>
                    </div>
                </div>
                <a href="/calendar" class="btn-add-task">Calendar View</a>
                <a href="/api/tasks/add" class="btn-add-task">Add Task</a>
            </div>
        </div>


        <form class="filters" th:action="@{/api/tasks}" method="get">

        <!-- Status -->
        <label>Status:</label>
        <select name="status" class="filter-input">
            <option value="">All</option>
            <option th:each="s : ${T(com.tracker.app.enums.TaskStatus).values()}"
                    th:value="${s}"
                    th:text="${#strings.capitalize(#strings.replace(s.name().toLowerCase(),'_',' '))}">
            </option>
        </select>

        <!-- Priority -->
        <label>Priority:</label>
        <select name="priority" class="filter-input">
            <option value="">All</option>
            <option th:each="p : ${T(com.tracker.app.enums.TaskPriority).values()}"
                    th:value="${p}"
                    th:text="${#strings.capitalize(p.name().toLowerCase())}">
            </option>
        </select>

        <!-- Title -->
        <label>Title:</label>
        <input type="text"
               name="keyword"
               placeholder="Search title"
               class="filter-input"
               th:value="${param.keyword}">

        <!-- Actions -->
        <button class="btn btn-filter">Filter</button>
        <a th:href="@{/api/tasks}" class="btn btn-clear">Clear</a>

        <!-- Sort -->
        <div class="sort-group">
            <span class="sort-label">Sort:</span>

            <a th:href="@{/api/tasks(
                sort='dueDate',
                status=${param.status},
                priority=${param.priority},
                keyword=${param.keyword}
            )}"
               class="sort-btn">
                Due Date
            </a>

            <a th:href="@{/api/tasks(
                sort='priority',
                status=${param.status},
                priority=${param.priority},
                keyword=${param.keyword}
            )}"
               class="sort-btn">
                Priority
            </a>

            <a th:href="@{/api/tasks(
                sort='title',
                status=${param.status},
                priority=${param.priority},
                keyword=${param.keyword}
            )}"
               class="sort-btn">
                Title
            </a>
        </div>

        </form>
        <div id="listView">
            <!-- Table -->
            <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Created At</th>
                <th>Completed At</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="task : ${tasks}"
                th:classappend="${task.status != T(com.tracker.app.enums.TaskStatus).DONE
                and task.dueDate != null
                and task.dueDate < #dates.format(#dates.createNow(),'yyyy-MM-dd')}
                ? 'overdue' : ''">



            <td th:text="${task.id}"></td>
                <td th:text="${task.title}"></td>
                <td th:text="${task.description}"></td>
                <td th:text="${task.dueDate}"></td>

                <td>
                    <span class="status"
                          th:text="${#strings.capitalize(#strings.replace(task.status.name().toLowerCase(),'_',' '))}"
                          th:classappend="${task.status.name()=='DONE'} ? ' status-done':' status-pending'">
                    </span>
                </td>

                <td>
                    <span class="badge"
                          th:text="${#strings.capitalize(task.priority.name().toLowerCase())}"
                          th:classappend="' badge-' + ${task.priority.name().toLowerCase()}">
                    </span>
                </td>

                <td th:text="${#temporals.format(task.createdAt,'dd-MM-yyyy HH:mm')}"></td>

                <td>
                    <span th:if="${task.completedAt != null}"
                          th:text="${#temporals.format(task.completedAt,'dd-MM-yyyy HH:mm')}"></span>
                    <span th:if="${task.completedAt == null}">‚Äî</span>
                </td>

                <td class="actions">

                    <!-- View -->
                    <a th:href="@{/api/tasks/view/{id}(id=${task.id})}"
                       class="action-btn">
                        View
                    </a>

                    <!-- Edit -->
                    <a th:href="@{/api/tasks/edit/{id}(id=${task.id})}"
                       class="action-btn">
                        Edit
                    </a>

                    <!-- Delete -->
                    <a th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
                       class="action-btn danger"
                       onclick="return confirm('Delete this task?')">
                        Delete
                    </a>

                    <!-- Mark Done (only if NOT DONE) -->
                    <!-- Mark Done -->
                    <a th:if="${task.status != T(com.tracker.app.enums.TaskStatus).DONE}"
                       th:href="@{/api/tasks/markdone/{id}(id=${task.id})}"
                       class="icon-btn mark-done"
                       title="Mark as Done"
                       onclick="return confirm('Mark this task as DONE?')">

                        <svg viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17l-5-5"
                                  stroke="#2e8b57"
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                        </svg>
                    </a>
                </td>

            </tr>
            </tbody>
                <tr th:if="${#lists.isEmpty(tasks)}">
                    <td colspan="9" class="table-empty">
                        <div class="table-empty-content">
                            <span class="icon">üóÇÔ∏è</span>
                            <p>No tasks found</p>
                            <a href="/api/tasks/add" class="btn-add-task small">
                                + Add Task
                            </a>
                        </div>
                    </td>
                </tr>


            </table>

            <!-- Pagination -->
            <div class="pagination" th:if="${totalPages > 1}">
            <a class="page-btn"
               th:classappend="${currentPage==0}? ' disabled':''"
               th:href="@{/api/tasks(page=${currentPage-1}, view='list')}">‚Äπ Prev</a>

            <a th:each="i : ${#numbers.sequence(0,totalPages-1)}"
               th:href="@{/api/tasks(page=${i}, view='list')}"
               th:text="${i+1}"
               class="page-number"
               th:classappend="${i==currentPage}? ' active':''"></a>

            <a class="page-btn"
               th:classappend="${currentPage==totalPages-1}? ' disabled':''"
               th:href="@{/api/tasks(page=${currentPage+1}, view='list')}">Next ‚Ä∫</a>
            </div>
        </div>
        <div id="cardView" class="task-cards" style="display:none">
            <div class="empty-state" th:if="${#lists.isEmpty(tasks)}">
                <div class="empty-icon">üóÇÔ∏è</div>
                <h3>No tasks found</h3>
                <p>You don‚Äôt have any tasks yet.<br>Click below to add your first task.</p>
                <a href="/api/tasks/add" class="btn-add-task">
                    + Add Task
                </a>
            </div>

            <div class="task-card"
                 th:each="task : ${tasks}"
                 th:classappend="${task.status != T(com.tracker.app.enums.TaskStatus).DONE
                and task.dueDate != null
                and task.dueDate < #dates.format(#dates.createNow(),'yyyy-MM-dd')}
                ? 'overdue' : ''">



            <!-- Title -->
                <h3 th:text="${task.title}">Task Title</h3>

                <!-- Description -->
                <p class="desc" th:text="${task.description}">Description</p>

                <!-- Status + Priority -->
                <div class="meta">
            <span class="status"
                  th:text="${#strings.capitalize(task.status.name().toLowerCase())}"
                  th:classappend="${task.status.name()=='DONE'} ? ' status-done':' status-pending'">
            </span>

                    <span class="badge"
                          th:text="${#strings.capitalize(task.priority.name().toLowerCase())}"
                          th:classappend="' badge-' + ${task.priority.name().toLowerCase()}">
            </span>
                </div>

                <!-- Dates -->
                <div class="dates">
                    <div>
                        üìÖ Due:
                        <span th:text="${task.dueDate}"></span>
                    </div>

                    <div>
                        ‚úÖ Completed:
                        <span th:if="${task.completedAt != null}"
                              th:text="${#temporals.format(task.completedAt,'dd-MM-yyyy HH:mm')}"
                              class="completed"></span>
                        <span th:if="${task.completedAt == null}">‚Äî</span>
                    </div>

                </div>

                <!-- Actions -->
                <div class="card-actions-row">

                    <a th:href="@{/api/tasks/view/{id}(id=${task.id})}"
                       class="action-btn">View</a>

                    <a th:href="@{/api/tasks/edit/{id}(id=${task.id})}"
                       class="action-btn">Edit</a>

                    <a th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
                       class="action-btn danger"
                       onclick="return confirm('Delete this task?')">
                        Delete
                    </a>

                    <a th:if="${task.status != T(com.tracker.app.enums.TaskStatus).DONE}"
                       th:href="@{/api/tasks/markdone/{id}(id=${task.id})}"
                       class="icon-btn mark-done"
                       title="Mark as Done"
                       onclick="return confirm('Mark this task as DONE?')">

                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M20 6L9 17l-5-5"
                                  stroke="#2e8b57"
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                        </svg>
                    </a>


                </div>

            </div>
            <div class="card-pagination-wrapper" th:if="${totalPages > 1}">
                <div class="card-pagination">
                    <a th:classappend="${currentPage==0}? ' disabled':''"
                       th:href="@{/api/tasks(page=${currentPage-1},view='card')}">
                        ‚ÄπPrev
                    </a>

                    <a th:each="i : ${#numbers.sequence(0,totalPages-1)}"
                       th:href="@{/api/tasks(page=${i},view='card')}"
                       th:text="${i+1}"
                       th:classappend="${i==currentPage}? ' active':''">
                    </a>

                    <a th:classappend="${currentPage==totalPages-1}? ' disabled':''"
                       th:href="@{/api/tasks(page=${currentPage+1},view='card')}">
                        Next‚Ä∫
                    </a>
                </div>
            </div>


        </div>

    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<div id="toast"
     th:if="${toastSuccess != null}"
     class="toast success"
     th:text="${toastSuccess}">
</div>

<div id="toast-error"
     th:if="${toastError != null}"
     class="toast error"
     th:text="${toastError}">
</div>
<script>
    setTimeout(() => {
        const toast = document.getElementById("toast");
        const errorToast = document.getElementById("toast-error");
        if (toast) toast.remove();
        if (errorToast) errorToast.remove();
    }, 3500);
</script>
<script>
    const toggleBtn = document.getElementById("toggleViewBtn");
    const listView = document.getElementById("listView");
    const cardView = document.getElementById("cardView");

    function getParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function setView(view) {
        if (view === "card") {
            listView.style.display = "none";
            cardView.style.display = "grid";
            toggleBtn.textContent = "List View";
        } else {
            cardView.style.display = "none";
            listView.style.display = "block";
            toggleBtn.textContent = "Card View";
        }
    }

    // On page load
    const currentView = getParam("view") || "list";
    setView(currentView);

    toggleBtn.addEventListener("click", () => {
        const newView = currentView === "card" ? "list" : "card";
        const params = new URLSearchParams(window.location.search);
        params.set("view", newView);
        window.location.search = params.toString();
    });
</script>


</body>
</html>